{"version":3,"sources":["../../../../dobuki.net/public/penguin-quest-2/main.js"],"names":["define","THREE","DOK","window","engine","Engine","eggMove","Vector3","lastThrow","forwardVector","moveVector","trigger","obj","Loop","addLoop","loop","bind","debug","fps","location","search","indexOf","control","a","b","c","document","getElementById","style","display","images","items","squid","normal","shadow","floor","ice","wall","picture_frame","water","door","bunny","still","left","right","walk","penguin","front","back","swim","slide","bigface","elf","SpriteSheet","preLoad","definedItems","orientations","biOrientations","getOrientation","angle","bi","orient","angleSplit","Math","PI","length","index","round","spriteRenderer","SpriteRenderer","range","random","x","y","n","r","CellType","ground","ObjectType","none","item","gameData","map","cells","objects","data","Loader","loadFile","result","JSON","parse","saveGame","url","request","XMLHttpRequest","params","stringify","open","setRequestHeader","onreadystatechange","readyState","status","send","getCellType","undefined","hasCell","hasWater","setCellType","value","getObjectType","hasCreature","objectTypeOverlay","getDynamicObjectType","setDynamicObjectType","setObjectType","setItem","noData","message","getData","setMessage","answered","dialogState","variable","shownText","showText","txt","show","dlg","innerText","showPrompter","prompter","answerbox","split","answers","setAnswer","answer","backgroundColor","color","pointerEvents","time","resetDialog","performAction","action","forEach","charAt","removeItem","substr","addItem","forwardCell","getForwardCell","z","tap","elem","untap","id","getAnswer","checkCondition","conditions","some","every","objLeft","objRight","inventory","unlocked","dialog","dialogTime","nullString","space20","promptProgress","dialogAction","setDialog","condition","rest","slice","join","trueValue","falseValue","getTextFromDialog","dt","getPrompterFromDialog","getActionFromDialog","margin","canGo","blocked","colliders","block","key","unlockTime","collisionPending","overallLight","collection","Collection","type","camera","position","width","height","cellType","objectType","size","cycle","timeCycle","light","push","SpriteObject","create","Camera","quaternions","groundQuaternionArray","spritesheet","getFrame","shiftDown","southQuaternionArray","northQuaternionArray","westQuaternionArray","eastQuaternionArray","overlaySprite","sizeX","sizeY","yOffset","shadowQuatArray","hasItem","bunnyOverlay","state","direction","orientation","predx","predz","moving","sprite","pLight","copy","getCameraQuaternionData","forwardMovement","setLength","add","penguinOverlay","dx","dz","dist","atan2","rotA","bigfaceOverlay","act","currentCellType","s","oldX","oldZ","cellChanged","pickItem","itemText","itemsText","count","updateInventory","inv","str","pickedItems","initialize","body","appendChild","renderer","domElement","getLoadingBar","setTimeout","gameLoaded","removeChild","startGame","getCamera","mz","rot","buttonDown","Mouse","setOnTouch","dy","down","clamp","forwardCellVector","fcDirty","onChangeForwardCell","objType","throwEgg","clearState","creatures","cellTypes","addEventListener","e","keyCode","console","log","prompt","shiftKey","egg","visible","setIndexProcessor","i","zIndex","abs","processImageIndex","image","geometry","SphereGeometry","material","MeshLambertMaterial","Mesh","set","scale","scene","AmbientLight","light2","PointLight","frame","textContent","lastMoveVector","oldForwardX","oldForwardZ","mov","Keyboard","getMove","quaternion","setFromAxisAngle","canGoX","canGoZ","canGoXZ","updateGraphics","col"],"mappings":"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","file":"main.js","sourcesContent":["define([\n        'threejs',\n        'dobuki',\n    ],\nfunction(THREE, DOK) {\n\n    window.THREE = THREE;\n    window.DOK = DOK;\n\n    const engine = new DOK.Engine();\n\n    var eggMove = new THREE.Vector3();\n    var lastThrow = 0;\n\n    var forwardVector = new THREE.Vector3(0,1,0);\n    var moveVector = new THREE.Vector3(0,0,0);\n\n\n\n    function trigger(obj) {\n        DOK.Loop.addLoop(obj.loop.bind(obj));\n    }\n\n    var debug = {\n        fps: location.search.indexOf(\"fps\")>=0,\n        control: location.search.indexOf(\"control\")>=0,\n        a:0,\n        b:0,\n        c:0,\n    };\n\n    document.getElementById(\"fps\").style.display = debug.fps ? \"\" : \"none\";\n\n    if(debug.control) {\n//        DOK.addControlBall();\n  //      DOK.addControlBox();\n    }\n\n    var images = {\n        items: [\n            \"assets/img/items.png|0,0,32,32\",\n            \"assets/img/items.png|32,0,32,32\",\n            \"assets/img/items.png|0,32,32,32\",\n            \"assets/img/items.png|32,32,32,32\",\n            [\n                \"assets/img/fish.png|0,0,16,16\",\n                \"assets/img/fish.png|0,16,16,16\",\n            ],\n        ],\n        squid: {\n            normal: [\n                \"lib/dobuki/images/squid.png|0,0,32,32\",\n                \"lib/dobuki/images/squid.png|32,0,32,32\",\n                \"lib/dobuki/images/squid.png|0,32,32,32\",\n                \"lib/dobuki/images/squid.png|32,32,32,32\",\n            ],\n            shadow: [\n                \"lib/dobuki/images/squid.png|0,0,32,32|shadow\",\n                \"lib/dobuki/images/squid.png|32,0,32,32|shadow\",\n                \"lib/dobuki/images/squid.png|0,32,32,32|shadow\",\n                \"lib/dobuki/images/squid.png|32,32,32,32|shadow\",\n            ]\n        },\n    //*\n        floor: [\n            \"assets/img/snow.png|0,0,32,32\",\n            \"assets/img/snow.png|32,0,32,32\",\n            \"assets/img/snow.png|0,32,32,32\",\n            \"assets/img/snow.png|32,32,32,32\",\n        ],\n        ice: [\n            \"assets/img/ice.png\",\n            \"assets/img/ice.png|scale:-1\",\n        ],\n        wall: [\n            \"assets/img/ice.png\",\n            \"assets/img/ice.png|scale:-1\",\n        ],\n        picture_frame: [\n            \"assets/img/penguin-quest.jpg\",\n        ],\n        /*/\n        floor: [\n            \"assets/img/ice.png|scale:-1,-1\",\n            \"assets/img/ice.png\",\n            \"assets/img/ice.png|scale:1,-1\",\n            \"assets/img/ice.png|scale:-1,1\",\n        ],\n        wall: [\n            \"assets/img/snow.png|0,0,32,32\",\n            \"assets/img/snow.png|32,0,32,32\",\n            \"assets/img/snow.png|0,32,32,32\",\n            \"assets/img/snow.png|32,32,32,32\",\n        ],\n        //*/\n        water: [\n            \"lib/dobuki/images/water.gif\",\n        ],\n        door: [\n            \"assets/img/wooddoor.png|cross\",\n        ],\n        bunny: {\n            normal: {\n                still: {\n                    left: [\n                        \"assets/img/bunny.png|0,0,32,32|scale:-1,1\",\n                        \"assets/img/bunny.png|32,0,32,32|scale:-1,1\",\n                    ],\n                    right: [\n                        \"assets/img/bunny.png|0,0,32,32\",\n                        \"assets/img/bunny.png|32,0,32,32\",\n                    ],\n                },\n                walk: {\n                    left: [\n                        \"assets/img/bunny.png|0,32,32,32|scale:-1,1\",\n                        \"assets/img/bunny.png|32,32,32,32|scale:-1,1\",\n                    ],\n                    right: [\n                        \"assets/img/bunny.png|0,32,32,32\",\n                        \"assets/img/bunny.png|32,32,32,32\",\n                    ],\n                }\n            },\n            shadow: {\n                still: {\n                    left: [\n                        \"assets/img/bunny.png|0,0,32,32|scale:-1,1|shadow\",\n                        \"assets/img/bunny.png|32,0,32,32|scale:-1,1|shadow\",\n                    ],\n                    right: [\n                        \"assets/img/bunny.png|0,0,32,32|shadow\",\n                        \"assets/img/bunny.png|32,0,32,32|shadow\",\n                    ],\n                },\n                walk: {\n                    left: [\n                        \"assets/img/bunny.png|0,32,32,32|scale:-1,1|shadow\",\n                        \"assets/img/bunny.png|32,32,32,32|scale:-1,1|shadow\",\n                    ],\n                    right: [\n                        \"assets/img/bunny.png|0,32,32,32|shadow\",\n                        \"assets/img/bunny.png|32,32,32,32|shadow\",\n                    ],\n                }\n            }\n        },\n        penguin: {\n            normal: {\n                front: [\n                    \"assets/img/penguin.png|0,0,32,32\",\n                    \"assets/img/penguin.png|32,0,32,32\",\n                    \"assets/img/penguin.png|0,32,32,32\",\n                    \"assets/img/penguin.png|32,32,32,32\",\n                ],\n                right: [\n                    \"assets/img/penguin-right.png|0,0,32,32\",\n                    \"assets/img/penguin-right.png|32,0,32,32\",\n                    \"assets/img/penguin-right.png|0,32,32,32\",\n                    \"assets/img/penguin-right.png|32,32,32,32\",\n                ],\n                left: [\n                    \"assets/img/penguin-right.png|0,0,32,32|scale:-1,1\",\n                    \"assets/img/penguin-right.png|32,0,32,32|scale:-1,1\",\n                    \"assets/img/penguin-right.png|0,32,32,32|scale:-1,1\",\n                    \"assets/img/penguin-right.png|32,32,32,32|scale:-1,1\",\n                ],\n                back: [\n                    \"assets/img/penguin-up.png|0,0,32,32\",\n                    \"assets/img/penguin-up.png|32,0,32,32\",\n                    \"assets/img/penguin-up.png|0,32,32,32\",\n                    \"assets/img/penguin-up.png|32,32,32,32\",\n                ],\n            },\n            shadow: {\n                front: [\n                    \"assets/img/penguin.png|0,0,32,32|shadow\",\n                    \"assets/img/penguin.png|32,0,32,32|shadow\",\n                    \"assets/img/penguin.png|0,32,32,32|shadow\",\n                    \"assets/img/penguin.png|32,32,32,32|shadow\",\n                ],\n                right: [\n                    \"assets/img/penguin-right.png|0,0,32,32|shadow\",\n                    \"assets/img/penguin-right.png|32,0,32,32|shadow\",\n                    \"assets/img/penguin-right.png|0,32,32,32|shadow\",\n                    \"assets/img/penguin-right.png|32,32,32,32|shadow\",\n                ],\n                left: [\n                    \"assets/img/penguin-right.png|0,0,32,32|scale:-1,1|shadow\",\n                    \"assets/img/penguin-right.png|32,0,32,32|scale:-1,1|shadow\",\n                    \"assets/img/penguin-right.png|0,32,32,32|scale:-1,1|shadow\",\n                    \"assets/img/penguin-right.png|32,32,32,32|scale:-1,1|shadow\",\n                ],\n                back: [\n                    \"assets/img/penguin-up.png|0,0,32,32|shadow\",\n                    \"assets/img/penguin-up.png|32,0,32,32|shadow\",\n                    \"assets/img/penguin-up.png|0,32,32,32|shadow\",\n                    \"assets/img/penguin-up.png|32,32,32,32|shadow\",\n                ],\n            },\n            swim: {\n                front: [\n                    \"assets/img/penguin-swim.png|0,0,32,32\",\n                    \"assets/img/penguin-swim.png|32,0,32,32\",\n                ],\n                right: [\n                    \"assets/img/penguin-swim-right.png|0,0,32,32\",\n                    \"assets/img/penguin-swim-right.png|32,0,32,32\",\n                    \"assets/img/penguin-swim-right.png|0,32,32,32\",\n                    \"assets/img/penguin-swim-right.png|32,32,32,32\",\n                ],\n                left: [\n                    \"assets/img/penguin-swim-right.png|0,0,32,32|scale:-1,1\",\n                    \"assets/img/penguin-swim-right.png|32,0,32,32|scale:-1,1\",\n                    \"assets/img/penguin-swim-right.png|0,32,32,32|scale:-1,1\",\n                    \"assets/img/penguin-swim-right.png|32,32,32,32|scale:-1,1\",\n                ],\n                back: [\n                    \"assets/img/penguin-swim.png|0,32,32,32\",\n                    \"assets/img/penguin-swim.png|32,32,32,32\",\n                ],\n            },\n            slide: {\n                front: [\n                    \"assets/img/slide-up-down.png|0,0,32,32\",\n                ],\n                right: [\n                    \"assets/img/slide-right.png|0,0,32,32\",\n                ],\n                left: [\n                    \"assets/img/slide-right.png|0,0,32,32|scale:-1,1\",\n                ],\n                back: [\n                    \"assets/img/slide-up-down.png|0,32,32,32\",\n                ],\n            },\n        },\n        bigface: {\n            normal: {\n                still: [\n                    \"assets/img/bigface.png|0,0,64,64\",\n                    \"assets/img/bigface.png|64,64,64,64\",\n                ],\n                walk: [\n                    \"assets/img/bigface.png|0,0,64,64\",\n                    \"assets/img/bigface.png|64,0,64,64\",\n                    \"assets/img/bigface.png|0,0,64,64|scale:-1,1\",\n                    \"assets/img/bigface.png|64,0,64,64|scale:-1,1\",\n                ],\n            },\n            shadow: {\n                still: [\n                    \"assets/img/bigface.png|0,0,64,64|shadow\",\n                    \"assets/img/bigface.png|64,64,64,64|shadow\",\n                ],\n                walk: [\n                    \"assets/img/bigface.png|0,0,64,64|shadow\",\n                    \"assets/img/bigface.png|64,0,64,64|shadow\",\n                    \"assets/img/bigface.png|0,0,64,64|scale:-1,1|shadow\",\n                    \"assets/img/bigface.png|64,0,64,64|scale:-1,1|shadow\",\n                ],\n            },\n        },\n        elf: {\n            normal: {\n                still: [\n                    \"assets/img/elf.png|0,0,64,64\",\n                    \"assets/img/elf.png|64,0,64,64\",\n                    \"assets/img/elf.png|0,64,64,64\",\n                ]\n            },\n            shadow: {\n                still: [\n                    \"assets/img/elf.png|0,0,64,64|shadow\",\n                    \"assets/img/elf.png|64,0,64,64|shadow\",\n                    \"assets/img/elf.png|0,64,64,64|shadow\",\n                ]\n            },\n        },\n    };\n    DOK.SpriteSheet.preLoad(images);\n\n    var definedItems = images.items;\n\n    var orientations = ['front', 'right', 'back', 'left'];\n    var biOrientations = ['front', 'back'];\n    function getOrientation(angle, bi) {\n        var orient = bi?biOrientations:orientations;\n        var angleSplit = Math.PI * 2 / orient.length;\n        var index = Math.round(angle / angleSplit) % orient.length;\n        if(index<0) {\n            index += orient.length;\n        }\n        return orient[index];\n    }\n\n    var spriteRenderer = new DOK.SpriteRenderer();\n\n\n    var range = 20;\n\n    function random(x, y, n) {\n        var r = Math.PI * ((x*13) ^ y*11 ^ n);\n        return r - Math.floor(r)\n    }\n\n    var CellType = {\n        wall: 1,\n        water: 2,\n        ground: 3,\n        ice: 4,\n    };\n\n    var ObjectType = {\n        none: 0,\n        squid: 1,\n        picture_frame: 2,\n        door: 3,\n        item: 4,\n        elf: 5,\n    };\n\n    var gameData = {\n        map: {\n            cells: {},\n            objects: {},\n            data: {},\n        },\n    };\n\n    DOK.Loader.loadFile('map.json', function(result) {\n        gameData = JSON.parse(result);\n        gameData.map = gameData.map || {};\n        gameData.map.cells = gameData.map.cells || {};\n        gameData.map.objects = gameData.map.objects || {};\n        gameData.map.data = gameData.map.data || {};\n    });\n\n    function saveGame(gameData) {\n    //        console.log(JSON.stringify(gameData));\n        var url = \"php/save.php?file=../map.json\";\n        var request = new XMLHttpRequest();\n        var params = JSON.stringify(gameData);\n        request.open(\"POST\", url, true);\n\n        request.setRequestHeader(\"Content-type\", \"application/json; charset=utf-8\");\n\n        request.onreadystatechange = function() {\n            if(request.readyState == 4 && request.status == 200) {\n    //                alert(request.responseText);\n            }\n        };\n        request.send(params);\n    }\n\n    function getCellType(x,y) {\n        x = Math.round(x); y = Math.round(y);\n        if ( gameData.map.cells[x+\"_\"+y] !== undefined) {\n            return gameData.map.cells[x+\"_\"+y];\n        }\n\n        var hasCell = random(x,y,0)<.6 || random((y/3)|0,(x/3)|0,1) < .1;\n        var hasWater = x%10===5 || y%20===10;\n        if(!hasCell) {\n            return CellType.wall;\n        } else if(hasWater) {\n            return CellType.water;\n        } else {\n            return CellType.ground;\n        }\n    }\n\n    function setCellType(x,y,value) {\n        gameData.map.cells[x+\"_\"+y] = value;\n        saveGame(gameData);\n    }\n\n\n    function getObjectType(x,y) {\n        x = Math.round(x); y = Math.round(y);\n        if ( gameData.map.objects[x+\"_\"+y] !== undefined) {\n            return gameData.map.objects[x+\"_\"+y];\n        }\n\n        var hasCreature = random(x,y,3)<.05;\n        if(hasCreature) {\n            return ObjectType.squid;\n        } else {\n            return ObjectType.none;\n        }\n    }\n\n    var objectTypeOverlay = {};\n    function getDynamicObjectType(x,y) {\n        if(objectTypeOverlay[x+\"_\"+y] !== undefined) {\n            return objectTypeOverlay[x+\"_\"+y];\n        }\n        return getObjectType(x,y);\n    }\n\n    function setDynamicObjectType(x,y,value) {\n        objectTypeOverlay[x+\"_\"+y] = value;\n    }\n\n    function setObjectType(x,y,value) {\n        if(value===ObjectType.none) {\n            setItem(x,y,0);\n        }\n        gameData.map.objects[x+\"_\"+y] = value;\n        saveGame(gameData);\n    }\n\n    var noData = { message:\"\", item:0 };\n    function getData(x,y) {\n        x = Math.round(x); y = Math.round(y);\n        return gameData.map.data[x+\"_\"+y] || noData;\n    }\n\n    function setMessage(x,y,value) {\n        gameData.map.data[x+\"_\"+y] = gameData.map.data[x+\"_\"+y]||{message:\"\", item:0};\n        gameData.map.data[x+\"_\"+y].message = value;\n        saveGame(gameData);\n    }\n\n    function setItem(x,y,value) {\n        setObjectType(x,y,ObjectType.item);\n        gameData.map.data[x+\"_\"+y] = gameData.map.data[x+\"_\"+y]||{};\n        gameData.map.data[x+\"_\"+y].item = value;\n        saveGame(gameData);\n    }\n\n    var answered = 0;\n    var dialogState = {};\n    var variable;\n    var shownText = null;\n    function showText(txt) {\n        if(shownText !== txt) {\n            var show = txt && txt.length;\n            var dlg = document.getElementById('dlg');\n            if(show && dlg.style.display==='none') {\n                dlg.style.display = '';\n            } else if(!show && dlg.style.display!=='none') {\n                dlg.style.display = 'none';\n            }\n            document.getElementById('msg').innerText = txt;\n            shownText = txt;\n        }\n    }\n\n    function showPrompter(prompter) {\n        if(prompter && prompter.length) {\n            if(answerbox.style.display==='none') {\n                answerbox.style.display = 'flex';\n                variable = prompter.split(\":\")[0];\n                prompter = prompter.split(\":\")[1];\n\n                var answers = prompter.split(\"/\");\n                setAnswer('a1',answers[0]);\n                setAnswer('a2',answers[1]);\n                setAnswer('a3',answers[2]);\n                answer = null;\n                answered = 0;\n\n                document.getElementById('a1').style.backgroundColor='';\n                document.getElementById('a2').style.backgroundColor='';\n                document.getElementById('a3').style.backgroundColor='';\n                document.getElementById('a1').style.color='';\n                document.getElementById('a2').style.color='';\n                document.getElementById('a3').style.color='';\n                document.getElementById('a1').style.pointerEvents = '';\n                document.getElementById('a2').style.pointerEvents = '';\n                document.getElementById('a3').style.pointerEvents = '';\n\n            }\n            if(answered && DOK.Loop.time-answered > 500) {\n                resetDialog(false);\n            }\n        } else {\n            if(answerbox.style.display!=='none') {\n                answerbox.style.display = 'none';\n            }\n        }\n    }\n\n    function performAction(action) {\n        if(action.indexOf(\"/\")>=0) {\n            action.split(\"/\").forEach(performAction);\n            return;\n        }\n\n        if(action.charAt(0)==='-') {\n            removeItem(action.substr(1));\n            return;\n        } else if(action.charAt(0)==='+') {\n            addItem(action.substr(1));\n            return;\n        }\n\n        var left = action.split(\":\")[0];\n        var forwardCell = getForwardCell();\n        var x = forwardCell.x;\n        var y = forwardCell.z;\n        switch(left) {\n            case \"bye\":\n                setDynamicObjectType(x,y,ObjectType.none);\n                break;\n        }\n    }\n\n    function tap(elem) {\n        document.getElementById('a1').style.backgroundColor='';\n        document.getElementById('a2').style.backgroundColor='';\n        document.getElementById('a3').style.backgroundColor='';\n        document.getElementById('a1').style.color='';\n        document.getElementById('a2').style.color='';\n        document.getElementById('a3').style.color='';\n        elem.style.backgroundColor = 'blue';\n        elem.style.color = 'white';\n    }\n\n    function untap(elem) {\n        elem.style.backgroundColor = 'green';\n        elem.style.color = 'white';\n        answered = DOK.Loop.time;\n        dialogState[variable] = elem.id.charAt(1);\n    //        answer = elem.innerText;\n        document.getElementById('a1').style.pointerEvents = 'none';\n        document.getElementById('a2').style.pointerEvents = 'none';\n        document.getElementById('a3').style.pointerEvents = 'none';\n    }\n\n    function getAnswer() {\n        if(answered && DOK.Loop.time - answered < 500) {\n            return answer;\n        }\n        return null;\n    }\n\n    function setAnswer(id,value) {\n        var elem = document.getElementById(id);\n        if(!value && elem.style.display!=='none') {\n            elem.style.display = 'none';\n        } else if(value) {\n            if(elem.style.display==='none')\n                elem.style.display = '';\n            elem.innerText = value;\n        }\n    }\n\n    function checkCondition(txt) {\n        var conditions = txt.split(\"||\");\n        if(conditions.length>1) {\n            return conditions.some(checkCondition);\n        }\n\n        conditions = txt.split(\"&&\");\n        if(conditions.length>1) {\n            return conditions.every(checkCondition);\n        }\n\n        if(txt.charAt(0)==='!') {\n            return !checkCondition(txt.substr(1));\n        }\n\n\n        var forwardCell = getForwardCell();\n\n        var objLeft = txt.split(\".\")[0];\n        var objRight = txt.split(\".\")[1];\n        switch(objLeft) {\n            case \"bye\":\n                return getDynamicObjectType(forwardCell.x,forwardCell.z)===ObjectType.none;\n                break;\n            case \"inventory\":\n                return inventory[objRight];\n                break;\n            case \"unlocked\":\n                return unlocked[forwardCell.x+\"_\"+forwardCell.z];\n                break;\n            case \"var\":\n                if(objRight.indexOf(\"=\")<0) {\n                    return dialogState[objRight];\n                }\n                var left = objRight.split(\"=\")[0];\n                var right = objRight.split(\"=\")[1];\n                if(right.length===0) {\n                    return !dialogState[left];\n                }\n                return dialogState[left] === right;\n                break;\n        }\n        return false;\n    }\n\n    var dialog = null; var dialogTime = 0, nullString = \"\",\n        space20 = \"                    \",prompter=null,\n        promptProgress = 0, dialogAction = null;\n\n    function setDialog(txt) {\n        if(txt) {\n            while(txt.indexOf(\"[?]\")>=0) {\n                var condition = txt.split(\"[?]\")[0];\n                var rest = txt.split(\"[?]\").slice(1).join(\"[?]\");\n\n                var trueValue = rest.split(\"[:]\")[0];\n                var falseValue = rest.split(\"[:]\").slice(1).join(\"[:]\");\n                if(checkCondition(condition)) {\n                    txt = trueValue;\n                } else {\n                    txt = falseValue;\n                }\n            }\n            prompter = null;\n            dialogAction = null;\n\n            if(txt.indexOf('>')>=0) {\n                dialogAction = txt.split(\">\")[1];\n                txt = txt.split(\">\")[0];\n            }\n            if(txt.indexOf('~')>=0) {\n                prompter = txt.split(\"~\")[1];\n                txt = txt.split(\"~\")[0];\n            }\n        }\n\n        dialog = txt ? txt.split(\"/\").join(space20 + \"\\n\") : null;\n        dialogTime = DOK.Loop.time;\n        promptProgress = 0;\n    }\n\n    function getTextFromDialog() {\n        var dt = ((DOK.Loop.time - dialogTime) / 40) | 0;\n        return dialog ? dialog.substr(0,dt) : nullString;\n    }\n\n    function getPrompterFromDialog() {\n        var dt = ((DOK.Loop.time - dialogTime) / 40) | 0;\n        return prompter && dialog && dt > dialog.length+10 ? prompter : nullString;\n    }\n\n    function getActionFromDialog() {\n        var dt = ((DOK.Loop.time - dialogTime) / 40) | 0;\n        return dialogAction && dialog && dt > dialog.length+10 ? dialogAction : nullString;\n    }\n\n    DOK.Loop.addLoop(function() {\n        showText(getTextFromDialog());\n        showPrompter(getPrompterFromDialog());\n        performAction(getActionFromDialog());\n    });\n\n\n    var margin = .4;\n    function canGo(x,y) {\n        x = x/256;\n        y = y/256;\n        return !blocked(x-margin,y-margin)\n            && !blocked(x+margin,y-margin)\n            && !blocked(x-margin,y+margin)\n            && !blocked(x+margin,y+margin);\n    }\n\n    var colliders = [\n        ObjectType.elf,\n    ];\n\n    function blocked(x,y) {\n        x = Math.round(x); y = Math.round(y);\n        var block = getCellType(x,y) === CellType.wall ||\n            colliders.indexOf(getDynamicObjectType(x,y)) >=0;\n\n        if(block && getDynamicObjectType(x,y)===ObjectType.door) {\n            if(!unlocked[x+\"_\"+y]) {\n                if(inventory.key) {\n                    removeItem('key');\n                    unlocked[x+\"_\"+y] = DOK.Loop.time;\n                }\n            }\n            return !unlocked[x+\"_\"+y] || DOK.Loop.time - unlocked[x+\"_\"+y] < unlockTime;\n        } else if(block && colliders.indexOf(getDynamicObjectType(x,y))>=0) {\n            if(collisionPending) {\n                return true;\n            }\n    //            setDialog(\"Hello, would you like to pass?|What is the magic word?\");\n            collisionPending = true;\n        }\n\n\n        return block;\n    }\n\n    var collisionPending = false;\n\n    var unlockTime = 400;\n\n    var unlocked = {};\n\n    var overallLight = .7;\n    var cells = [];\n    var collection = new DOK.Collection(\n        {\n            type: \"grid\",\n            get x() {\n                return -Math.floor(range/2 - camera.position.x/256);\n            },\n            get y() {\n                return -Math.floor(range/2 - camera.position.z/256);\n            },\n            width: range,\n            height: range,\n        },\n        function(x,y) {\n            //console.log(x,y);\n            cells.length = 0;\n            var cellType = getCellType(x,y);\n            var objectType = getDynamicObjectType(x,y);\n            var size = 257;\n            var cycle = (random(x,y,100)*1000) | 0;\n            var timeCycle = cycle+(DOK.Loop.time/100)|0;\n\n            var forwardCell = getForwardCell();\n            var light = overallLight;\n            if(forwardCell.x === x && forwardCell.z === y) {\n    //                light = .7;\n            }\n\n            if(cellType === CellType.water) {\n                cells.push(DOK.SpriteObject.create(\n                    x*256,-64-20,y*256,\n                    size,size,\n                    DOK.Camera.quaternions.groundQuaternionArray,\n                    DOK.SpriteSheet.spritesheet.water.getFrame(cycle),\n                    light,\n                    0\n                ));\n            } else if(cellType === CellType.ice) {\n                cells.push(DOK.SpriteObject.create(\n                    x*256,-64,y*256,\n                    size,size,\n                    DOK.Camera.quaternions.groundQuaternionArray,\n                    DOK.SpriteSheet.spritesheet.ice.getFrame(cycle),\n                    light*2,\n                    0\n                ));\n            } else if(cellType === CellType.ground) {\n                cells.push(DOK.SpriteObject.create(\n                    x*256,-64,y*256,\n                    size,size,\n                    DOK.Camera.quaternions.groundQuaternionArray,\n                    DOK.SpriteSheet.spritesheet.floor.getFrame(cycle),\n                    light,\n                    0\n                ));\n            } else {\n                if(!unlocked[x+\"_\"+y] || DOK.Loop.time-unlocked[x+\"_\"+y] < unlockTime) {\n\n                    var shiftDown = unlocked[x+\"_\"+y]\n                        ? (DOK.Loop.time - unlocked[x+\"_\"+y]) * 256 / unlockTime\n                        : 0;\n\n                    cells.push(DOK.SpriteObject.create(\n                        x * 256, -64 + 128 - shiftDown, y * 256 + 128,\n                        size, size,\n                        DOK.Camera.quaternions.southQuaternionArray,\n                        light,\n                        DOK.SpriteSheet.spritesheet.wall.getFrame(cycle)\n                    ));\n                    cells.push(DOK.SpriteObject.create(\n                        x * 256, -64 + 128 - shiftDown, y * 256 - 128,\n                        size, size,\n                        DOK.Camera.quaternions.northQuaternionArray,\n                        light,\n                        DOK.SpriteSheet.spritesheet.wall.getFrame(cycle)\n                    ));\n                    cells.push(DOK.SpriteObject.create(\n                        x * 256 - 128, -64 + 128 - shiftDown, y * 256,\n                        size, size,\n                        DOK.Camera.quaternions.westQuaternionArray,\n                        light,\n                        DOK.SpriteSheet.spritesheet.wall.getFrame(cycle)\n                    ));\n                    cells.push(DOK.SpriteObject.create(\n                        x * 256 + 128, -64 + 128 - shiftDown, y * 256,\n                        size, size,\n                        DOK.Camera.quaternions.eastQuaternionArray,\n                        light,\n                        DOK.SpriteSheet.spritesheet.wall.getFrame(cycle)\n                    ));\n                    cells.push(DOK.SpriteObject.create(\n                        x * 256, -64 + 256 - shiftDown, y * 256,\n                        size, size,\n                        DOK.Camera.quaternions.groundQuaternionArray,\n                        light,\n                        DOK.SpriteSheet.spritesheet.wall.getFrame(cycle)\n                    ));\n                }\n            }\n\n            var overlaySprite = null;\n            var sizeX, sizeY;\n            var yOffset;\n\n            if(objectType===ObjectType.picture_frame) {\n                overlaySprite = DOK.SpriteSheet.spritesheet.picture_frame.getFrame(cycle);\n                sizeX = 200; sizeY = 150;\n                yOffset = 128;\n            } else if(objectType===ObjectType.door) {\n                if(!unlocked[x+\"_\"+y] || DOK.Loop.time-unlocked[x+\"_\"+y] < unlockTime) {\n\n                    var shiftDown = unlocked[x+\"_\"+y]\n                        ? (DOK.Loop.time - unlocked[x+\"_\"+y]) * 256 / unlockTime\n                        : 0;\n\n                    overlaySprite = DOK.SpriteSheet.spritesheet.door.getFrame(cycle);\n                    sizeX = 150; sizeY = 250;\n                    yOffset = 128 - shiftDown;\n                }\n            }\n\n            if (overlaySprite) {\n                cells.push(DOK.SpriteObject.create(\n                    x * 256, -64 + yOffset, y * 256 + 128 + 1,\n                    sizeX, sizeY,\n                    DOK.Camera.quaternions.southQuaternionArray,\n                    overlaySprite,\n                    light,\n                    0\n                ));\n                cells.push(DOK.SpriteObject.create(\n                    x*256,-64+yOffset,y*256-128-1,\n                    sizeX,sizeY,\n                    DOK.Camera.quaternions.northQuaternionArray,\n                    overlaySprite,\n                    light,\n                    0\n                ));\n                cells.push(DOK.SpriteObject.create(\n                    x*256-128-1,-64+yOffset,y*256,\n                    sizeX,sizeY,\n                    DOK.Camera.quaternions.westQuaternionArray,\n                    overlaySprite,\n                    light,\n                    0\n                ));\n                cells.push(DOK.SpriteObject.create(\n                    x*256+128+1,-64+yOffset,y*256,\n                    sizeX,sizeY,\n                    DOK.Camera.quaternions.eastQuaternionArray,\n                    overlaySprite,\n                    light,\n                    0\n                ));\n            }\n\n            if(objectType === ObjectType.squid) {\n                cells.push(DOK.SpriteObject.create(\n                    x * 256, -64 + 128, y * 256,\n                    size, size,\n                    null,\n                    DOK.SpriteSheet.spritesheet.squid.normal.getFrame(timeCycle),\n                    light,\n                    0\n                ));\n                cells.push(DOK.SpriteObject.create(\n                    x * 256, -64 + 1, y * 256,\n                    size, size,\n                    DOK.Camera.shadowQuatArray(x * 256, y * 256),\n                    DOK.SpriteSheet.spritesheet.squid.shadow.getFrame(timeCycle),\n                    overallLight,\n                    0\n                ));\n            } else if(objectType === ObjectType.elf) {\n                cells.push(DOK.SpriteObject.create(\n                    x*256,-64+128-100,y*256,\n                    size/4,size/4,\n                    null,\n                    DOK.SpriteSheet.spritesheet.elf.normal.still.getFrame(timeCycle),\n                    light * 2,\n                    0\n                ));\n                cells.push(DOK.SpriteObject.create(\n                    x*256,-64+1,y*256,\n                    size/4,size/4,\n                    DOK.Camera.shadowQuatArray(x*256,y*256),\n                    DOK.SpriteSheet.spritesheet.elf.shadow.still.getFrame(timeCycle),\n                    overallLight,\n                    0\n                ));\n            } else if(objectType===ObjectType.item) {\n                if(hasItem(x,y)) {\n                    var item = getData(x,y).item;\n                    cells.push(DOK.SpriteObject.create(\n                        x*256,-64+128-100,y*256,\n                        50,50,\n                        null,\n                        DOK.SpriteSheet.spritesheet.items[item].getFrame(timeCycle),\n                        light,\n                        0\n                    ));\n                }\n            }\n\n            return cells;\n        }\n    );\n\n    var bunnyOverlay = {\n        state: 'still',\n        direction: 'left',\n        orientation: orientations[0],\n        position: new THREE.Vector3(),\n        predx: 0, predz: 0,\n        cycle: 0,\n        moving: false,\n        get sprite() {\n            return DOK.SpriteObject.create(\n                this.position.x,this.position.y-35,this.position.z,\n                30,30,\n                null,\n                DOK.SpriteSheet.spritesheet.bunny.normal[this.state][this.direction].getFrame(this.cycle),\n                pLight,\n                0\n            );\n        },\n        get shadow() {\n            return DOK.SpriteObject.create(\n                this.position.x,this.position.y-40,this.position.z,\n                30,30,\n                DOK.Camera.shadowQuatArray(this.position.x,this.position.z),\n                DOK.SpriteSheet.spritesheet.bunny.shadow[this.state][this.direction].getFrame(this.cycle),\n                pLight,\n                0\n            );\n        },\n        loop: function() {\n            moveVector.copy(DOK.Camera.getCameraQuaternionData().forwardMovement);\n            moveVector.setLength(-100);\n            moveVector.add(penguinOverlay.position);\n\n            var dx = (moveVector.x - this.position.x)*.05;\n            var dz = (moveVector.z - this.position.z)*.05;\n            var dist = dx*dx + dz*dz;\n            if(dist > 100) {\n                this.moving = true;\n            } else if(dist < .5) {\n                this.moving = false;\n            }\n\n            if(this.moving) {\n                this.position.x += dx;\n                this.position.z += dz;\n                this.predx = dx; this.predz = dz;\n            }\n            this.cycle = !this.moving?DOK.Loop.time/2000|0:DOK.Loop.time/100|0;\n            var orientation = !this.moving\n                ? getOrientation(Math.atan2(this.predx,this.predz)-rotA)\n                : getOrientation(Math.atan2(dx,dz)-rotA);\n            this.state = !this.moving?'still':'walk';\n            this.direction = orientation === \"front\"\n                ? \"left\"\n                : orientation === \"back\"\n                    ? \"right\" : orientation;\n    ///            return false;\n        }\n    };\n    trigger(bunnyOverlay);\n\n\n    var bigfaceOverlay = {\n        state: 'still',\n        position: new THREE.Vector3(),\n        predx: 0, predz: 0,\n        cycle: 0,\n        moving: false,\n        get sprite() {\n            return DOK.SpriteObject.create(\n                this.position.x,this.position.y-35,this.position.z,\n                70,70,\n                null,\n                DOK.SpriteSheet.spritesheet.bigface.normal[this.state].getFrame(this.cycle),\n                pLight,\n                0\n            );\n        },\n        get shadow() {\n            return DOK.SpriteObject.create(\n                this.position.x,this.position.y-40,this.position.z,\n                70,70,\n                DOK.Camera.shadowQuatArray(this.position.x,this.position.z),\n                DOK.SpriteSheet.spritesheet.bigface.shadow[this.state].getFrame(this.cycle),\n                pLight,\n                0\n            );\n        },\n        loop: function() {\n            var dx = (bunnyOverlay.position.x + 100 - this.position.x)*.02;\n            var dz = (bunnyOverlay.position.z + 100 - this.position.z)*.02;\n            var dist = dx*dx + dz*dz;\n            if(dist > 10) {\n                this.moving = true;\n            } else if(dist < .5) {\n                this.moving = false;\n            }\n\n            if(this.moving) {\n                this.position.x += dx;\n                this.position.z += dz;\n                this.predx = dx; this.predz = dz;\n            }\n            this.cycle = !this.moving?DOK.Loop.time/2000|0:DOK.Loop.time/100|0;\n            this.state = !this.moving?'still':'walk';\n    ///            return false;\n        }\n    };\n    trigger(bigfaceOverlay);\n\n\n\n    var pLight = 1.8;\n    var penguinOverlay = {\n        predx: 0, predz: 0,\n        orientation: orientations[0],\n        position: new THREE.Vector3(),\n        cycle: 0,\n        get sprite() {\n            var act = currentCellType===CellType.water\n                ? 'swim'\n                : currentCellType===CellType.ice\n                    ? 'slide'\n                    : 'normal';\n            return DOK.SpriteObject.create(\n                this.position.x,this.position.y-35,this.position.z,\n                30,30,\n                null,\n                DOK.SpriteSheet.spritesheet.penguin[act][this.orientation].getFrame(this.cycle),\n                pLight,\n                0\n            );\n        },\n        get shadow() {\n            return currentCellType===CellType.water ? null : DOK.SpriteObject.create(\n                this.position.x,this.position.y-40,this.position.z,\n                30,30,\n                DOK.Camera.shadowQuatArray(this.position.x,this.position.z),\n                DOK.SpriteSheet.spritesheet.penguin.shadow[this.orientation].getFrame(this.cycle),\n                pLight,\n                0\n            );\n        },\n        loop: function() {\n            moveVector.copy(DOK.Camera.getCameraQuaternionData().forwardMovement);\n            moveVector.setLength(-80);\n            moveVector.add(camera.position);\n    //            moveVector.x += debug.a;\n    //            moveVector.z += debug.c;\n\n            var dx = (moveVector.x - this.position.x)*.8;\n            var dz = (moveVector.z - this.position.z)*.8;\n            var dist = dx*dx + dz*dz;\n            var s = .01;\n            this.cycle = dist<s?0:DOK.Loop.time/100|0;\n            var oldX = Math.round(this.position.x/256);\n            var oldZ = Math.round(this.position.z/256);\n            this.position.x += dx;\n            this.position.z += dz;\n            this.orientation = dist<s\n                ? getOrientation(Math.atan2(this.predx,this.predz)-rotA, true)\n                : getOrientation(Math.atan2(dx,dz)-rotA);\n            this.predx = dx; this.predz = dz;\n            if(Math.round(this.position.x/256) !== oldX || Math.round(this.position.z/256) !== oldZ) {\n                cellChanged(Math.round(this.position.x/256), Math.round(this.position.z/256));\n            }\n    ///            return false;\n        }\n    };\n    trigger(penguinOverlay);\n\n    var currentCellType = null;\n    function cellChanged(x,y) {\n        if(hasItem(x,y)) {\n            var item = getData(x,y).item;\n            pickItem(x,y);\n    //            console.log(x,y,item);\n            var itemText = itemsText[item];\n            addItem(itemText);\n        }\n        currentCellType = getCellType(x,y);\n    }\n\n    function addItem(item,count) {\n        if(count===undefined) {\n            count = 1;\n        }\n        inventory[item] = (inventory[item]||0)+count;\n        updateInventory();\n    }\n\n    function removeItem(item,count) {\n        if(count===undefined) {\n            count = 1;\n        }\n        if(inventory[item]) {\n            inventory[item]-=count;\n        }\n        if(inventory[item]<=0) {\n            delete inventory[item];\n        }\n        updateInventory();\n    }\n\n    function updateInventory() {\n        var inv = document.getElementById('inventory');\n        var str = [];\n        for(var a in inventory) {\n            str.push(a + (inventory[a]>1?\": \" + inventory[a]:\"\"));\n        }\n        inv.innerText = str.join(\"<br>\\n\");\n    }\n\n    var inventory = {};\n\n    var itemsText = [\n        \"key\",\n        \"carrot\",\n        \"ice cream\",\n        \"candle\",\n        \"fish\",\n    ];\n\n    var pickedItems = {};\n\n\n    function hasItem(x,y) {\n        return !pickedItems[x+\"_\"+y] && getDynamicObjectType(x,y)===ObjectType.item;\n    }\n\n    function pickItem(x,y) {\n        var item = getData(x,y).item;\n        pickedItems[x+\"_\"+y] = DOK.Loop.time;\n        setDialog(\"+ \" + itemsText[item]);\n    }\n\n    function initialize() {\n        document.body.appendChild(engine.renderer.domElement);\n        DOK.Loader.getLoadingBar();\n//        DOK.Loader.setOnLoad(gameLoaded);\n        setTimeout(gameLoaded, 1000);\n    }\n\n    function gameLoaded() {\n        document.body.removeChild(DOK.Loader.getLoadingBar());\n        startGame();\n    }\n\n    var camera = DOK.Camera.getCamera();\n    var mz = 0, rot = 0, rotA = 0, buttonDown = false;\n    DOK.Mouse.setOnTouch(\n        function(dx,dy,down) {\n            if(dx!==null) {\n                rot = THREE.Math.clamp(rot + dx/200, -10, 10);\n            }\n            if(dy!==null) {\n                mz = THREE.Math.clamp(mz - dy/2, -50, 20);\n            }\n            buttonDown = down;\n        }\n    );\n\n    var forwardCellVector, fcDirty;\n    function getForwardCell() {\n        if (!forwardCellVector) {\n            forwardCellVector = new THREE.Vector3();\n            fcDirty = true;\n        }\n        if(fcDirty) {\n            forwardCellVector.copy(DOK.Camera.getCameraQuaternionData().forwardMovement);\n            forwardCellVector.setLength(-200);\n            forwardCellVector.add(camera.position);\n            forwardCellVector.x = Math.round(forwardCellVector.x/256);\n            forwardCellVector.z = Math.round(forwardCellVector.z/256);\n            fcDirty = false;\n        }\n        return forwardCellVector;\n    }\n\n    function onChangeForwardCell() {\n        resetDialog(true);\n\n        if(DOK.Loop.time - lastThrow > 1000) {\n            var forwardCell = getForwardCell();\n            var objType = getObjectType(forwardCell.x, forwardCell.z);\n            if (objType === ObjectType.squid) {\n                throwEgg(forwardCell.x, forwardCell.z);\n            }\n        }\n    }\n\n    function resetDialog(clearState) {\n        var dlg = getData(getForwardCell().x, getForwardCell().z).message;\n        setDialog(dlg);\n        if(clearState) {\n            dialogState = {};\n        }\n    }\n\n    var creatures = [\n        ObjectType.none,\n        ObjectType.squid,\n        ObjectType.elf,\n    ];\n\n    var cellTypes = [\n        CellType.ground,\n        CellType.wall,\n        CellType.water,\n        CellType.ice,\n    ];\n    document.addEventListener(\"keydown\",\n        function(e) {\n            var forwardCell = getForwardCell();\n            switch(e.keyCode) {\n                case 32:\n                    console.log(\n                        getCellType(forwardCell.x,forwardCell.z),\n                        getObjectType(forwardCell.x,forwardCell.z)\n                    );\n                    break;\n                case 67:\n                    var objType = getObjectType(forwardCell.x,forwardCell.z);\n                    if(creatures.indexOf(objType)>=0) {\n                        objType = creatures[(creatures.indexOf(objType)+1) % creatures.length];\n                    } else {\n                        objType = ObjectType.none;\n                    }\n                    setObjectType(forwardCell.x,forwardCell.z, objType);\n                    break;\n                case 79:\n                    var objType = getObjectType(forwardCell.x,forwardCell.z);\n                    setObjectType(forwardCell.x,forwardCell.z,\n                        objType===ObjectType.picture_frame ? ObjectType.none : ObjectType.picture_frame\n                    );\n                    break;\n                case 49:\n                    var cellType = getCellType(forwardCell.x,forwardCell.z);\n                    if(cellTypes.indexOf(cellType)>=0) {\n                        cellType = cellTypes[(cellTypes.indexOf(cellType)+1) % cellTypes.length];\n                    } else {\n                        cellType = CellType.ground;\n                    }\n                    setCellType(forwardCell.x,forwardCell.z, cellType);\n                    break;\n                case 71:\n                    var objType = getObjectType(forwardCell.x,forwardCell.z);\n                    setObjectType(forwardCell.x,forwardCell.z,\n                        objType===ObjectType.door ? ObjectType.none : ObjectType.door\n                    );\n                    break;\n                case 73:\n                    var objType = getObjectType(forwardCell.x,forwardCell.z);\n                    if(objType!==ObjectType.item) {\n                        setItem(forwardCell.x,forwardCell.z,0);\n                    } else {\n                        if (pickedItems[forwardCell.x+\"_\"+forwardCell.z]) {\n                            delete pickedItems[forwardCell.x+\"_\"+forwardCell.z];\n                        } else {\n                            var item = getData(forwardCell.x,forwardCell.z).item;\n                            if(item+1<definedItems.length) {\n                                setItem(forwardCell.x,forwardCell.z,item+1);\n                            } else {\n                                setObjectType(forwardCell.x,forwardCell.z,ObjectType.none);\n                            }\n                        }\n                    }\n                    break;\n                case 13:\n                    var message = getData(forwardCell.x,forwardCell.z).message;\n                    message = prompt(message.split(\"/\").join(\"\\n/\"),message);\n                    if(message !== null) {\n                        setMessage(forwardCell.x,forwardCell.z,message);\n                    }\n                    break;\n                case 191:   //  ?\n                    if(e.shiftKey) {\n                        console.log(\n                            getCellType(forwardCell.x,forwardCell.z),\n                            getObjectType(forwardCell.x,forwardCell.z),\n                            getData(forwardCell.x,forwardCell.z)\n                        );\n                    }\n                    break;\n            }\n        }\n    );\n\n    function throwEgg(x,y) {\n        egg.visible = true;\n        egg.position.copy(penguinOverlay.position);\n        egg.position.y = -30;\n        eggMove.x = x*256-egg.position.x;\n        eggMove.z = y*256-egg.position.z;\n    //        eggMove.copy(DOK.Camera.getCameraQuaternionData().forwardMovement);\n    //        eggMove.negate();\n        eggMove.setLength(20);\n        eggMove.y = 15;\n        egg.position.add(eggMove);\n        lastThrow = DOK.Loop.time;\n    }\n\n    DOK.SpriteRenderer.setIndexProcessor(function(images, count) {\n        for (var i = 0; i < count; i++) {\n            images[i].zIndex += -Math.abs(images[i].position.y) * 10\n        }\n    });\n\n    function processImageIndex(image) {\n        image.zIndex -= Math.abs(image.position.y) * 10;\n    }\n\n\n    var geometry = new THREE.SphereGeometry(3, 20, 20, 0, Math.PI * 2, 0, Math.PI * 2);\n    //    var material = new THREE.MeshNormalMaterial();\n    var material = new THREE.MeshLambertMaterial();\n    var egg = new THREE.Mesh(geometry, material);\n    egg.position.set(0,-50,0);\n    egg.geometry.scale(3,3,3);\n    engine.scene.add(egg);\n    var light = new THREE.AmbientLight( 0xcccccc ); // soft white light\n    engine.scene.add( light );\n    var light2 = new THREE.PointLight( 0xffffff, 1, 0, 5 );\n    light2.position.set( -50, 250, 50 );\n    engine.scene.add( light2 );\n    egg.visible = false;\n\n\n    function startGame() {\n        DOK.fps = 45;\n        var frame = 0;\n        DOK.Loop.addLoop(function() {\n            frame++;\n            if(debug.fps && frame%10===0)\n                document.getElementById(\"fps\").textContent = DOK.Loop.fps + \" fps\";\n        });\n        DOK.Loop.addLoop(function() {\n            if(egg.visible) {\n                egg.position.add(eggMove);\n                eggMove.y-=2;\n            }\n            if(DOK.Loop.time - lastThrow > 1000) {\n                var forwardCell = getForwardCell();\n                var objType = getObjectType(forwardCell.x,forwardCell.z);\n                if(objType===ObjectType.squid) {\n                    throwEgg(forwardCell.x,forwardCell.z);\n                } else {\n                    egg.visible = false;\n                }\n            }\n        });\n\n        var lastMoveVector = new THREE.Vector3();\n        DOK.Loop.addLoop(function() {\n            if(debug.control)\n                return;\n            var oldForwardX = getForwardCell().x;\n            var oldForwardZ = getForwardCell().z;\n            var camera = DOK.Camera.getCamera();\n            var mov = DOK.Keyboard.getMove();\n            rot = THREE.Math.clamp(rot - mov[0]*.05, -10, 10);\n            mz = THREE.Math.clamp(mz - mov[1], -50, 20);\n            if(currentCellType===CellType.water) {\n                mz *= .75;\n            }\n\n            moveVector.copy(DOK.Camera.getCameraQuaternionData().forwardMovement);\n            if(Math.abs(mz)>0) {\n                mz *= .9;\n            } else {\n                mz = 0;\n            }\n            moveVector.setLength(mz);\n\n            if(currentCellType===CellType.ice) {\n                moveVector.add(lastMoveVector);\n            } else {\n                lastMoveVector.copy(moveVector);\n            }\n\n\n            if(Math.abs(rot)>.01) {\n                rotA = (rotA + rot) % (Math.PI*2);\n                rot *= .5;\n            }\n\n            camera.quaternion.setFromAxisAngle(forwardVector, rotA);\n            var canGoX = canGo(camera.position.x + moveVector.x, camera.position.z);\n            var canGoZ = canGo(camera.position.x, camera.position.z + moveVector.z);\n            var canGoXZ = canGo(camera.position.x + moveVector.x, camera.position.z + moveVector.z);\n\n            if(canGoX && canGoZ && canGoXZ) {\n            } else if(canGoX) {\n                moveVector.z = 0;\n            } else if(canGoZ) {\n                moveVector.x = 0;\n            } else {\n                moveVector.x = 0;\n                moveVector.z = 0;\n            }\n            camera.position.add(moveVector);\n            fcDirty = true;\n            if(getForwardCell().x !== oldForwardX || getForwardCell().z !== oldForwardZ) {\n                onChangeForwardCell();\n            }\n        });\n\n        DOK.Loop.addLoop(function() {\n            collection.forEach(spriteRenderer.display);\n            spriteRenderer.display(penguinOverlay.sprite);\n            spriteRenderer.display(penguinOverlay.shadow);\n            spriteRenderer.display(bunnyOverlay.sprite);\n            spriteRenderer.display(bunnyOverlay.shadow);\n            spriteRenderer.display(bigfaceOverlay.sprite);\n            spriteRenderer.display(bigfaceOverlay.shadow);\n            spriteRenderer.updateGraphics();\n        });\n    }\n\n//    document.addEventListener(\"DOMContentLoaded\",initialize);\n    setTimeout(initialize,100);\n    window.col = collection;\n});\n\n"]}